#!/bin/bash

set -eux

# refs:
# github.com/Stremio/vlc-android-sdk/blob/d8ab13e/prepare-aar
# gitlab.com/fdroid/fdroiddata/-/blob/81c14003f/metadata/com.tailscale.ipn.yml
# gitlab.com/fdroid/fdroiddata/-/blob/d6c5315a/metadata/org.calyxinstitute.vpn.yml

# download golang
curl -Lso go.tar.gz https://golang.org/dl/go1.15.4.linux-amd64.tar.gz
echo "eb61005f0b932c93b424a3a4eaa67d72196c79129d9a3ea8578047683e2c80d5 go.tar.gz" | sha256sum -c -

# setup golang
mkdir -p golang
tar -C golang -xzf go.tar.gz
export GOPATH="$(pwd)"
export GO_LANG="$(pwd)/golang/go/bin"
export GO_COMPILED="$(pwd)/bin"
export PATH="$GO_LANG:$GO_COMPILED:$PATH"

# init gomobile
go get golang.org/x/mobile/cmd/gomobile
gomobile init

# download firestack
git clone "https://github.com/celzero/outline-go-tun2socks.git" -b "$VERSION" go-firestack
cd go-firestack

# godeps
go get -d ./...

# gomobile aar
./build_android.sh intra

# rename
mv ./"$BOUT" ./"$FOUT"

